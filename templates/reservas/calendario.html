{% extends "base.html" %}
{% load utils %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.17/index.global.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.17/index.global.min.css" rel="stylesheet">
{% endblock head %}

{% block content %}
 <!-- Header Section -->
 <div class="container mx-auto px-6 py-8 bg-base-100 rounded-2xl shadow-sm p-8 mb-6">
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
        <div class="flex-1">
            <div class="flex items-center gap-3 mb-2">
                <div class="text-2xl text-primary">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <h1 class="text-3xl font-bold text-base-content">Calendario de Reservas</h1>
            </div>
            <p class="text-sm text-base-content/60 max-w-2xl">
                Aquí podrás ver el calendario de reservas de la aplicación.
            </p>
        </div>

        {% if crud_urls.create %}
        <div class="flex items-center gap-3">
            
            <button class="btn btn-primary btn-sm gap-2 open-modal-btn" 
                    data-url="{% url crud_urls.create %}"
                    data-success-callback="reloadRow">
                <i class="fas fa-plus text-xs"></i>
                Crear Reserva
            </button>
        </div>
        {% endif %}
    </div>
</div>

{% include "includes/calendario.html" %}
{% endblock %}

{% block scripts %}
<script type="module" src="https://unpkg.com/cally"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.17/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.17/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.17/index.global.min.js"></script>


<script>
    function reservasCalendar(config = {}) {
        return {
            // Configuración
            reservasJsonUrl: config.reservasJsonUrl || '/api/reservas-json/',
            reservasByDateUrl: config.reservasByDateUrl || '/api/reservas-by-date-json/',
            editUrlTemplate: config.editUrlTemplate || '/reservas/edit/RESERVATION_ID/',
            calendarId: config.calendarId || 'main',

            // Estado
            filterStatus: 'all',
            selectedDate: null,
            calendar: null,

            // Inicialización
            init() {
                this.$nextTick(() => {
                    this.initCalendar();
                });

                // Escuchar eventos de fecha seleccionada
                window.addEventListener('fecha-seleccionada', (event) => {
                    this.selectedDate = event.detail;
                    this.loadReservasWithHTMX(this.selectedDate);
                });
            },

            // Métodos
            initCalendar() {
                const calendarEl = document.getElementById(`calendar-${this.calendarId}`);
                if (!calendarEl) {
                    console.error(`Calendar element with id 'calendar-${this.calendarId}' not found`);
                    return;
                }

                this.calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'es',
                    firstDay: 1,
                    validRange: {
                        start: new Date()
                    },
                    headerToolbar: {
                        left: '',
                        center: 'title',
                        right: ''
                    },
                    buttonText: {
                        today: 'Hoy',
                        month: 'Mes',
                        week: 'Semana',
                        day: 'Día'
                    },
                    events: this.fetchEvents.bind(this),
                    dateClick: this.handleDateClick.bind(this),
                    eventClick: this.handleEventClick.bind(this),
                    height: 'auto',
                    aspectRatio: 1.6
                });

                this.calendar.render();
                window.calendarInstance = this.calendar;
            },

            async fetchEvents(fetchInfo, successCallback, failureCallback) {
                try {
                    const start = fetchInfo.startStr;
                    const end = fetchInfo.endStr;
                    const status = this.filterStatus !== 'all' ? this.filterStatus : '';
                    
                    const url = `${this.reservasJsonUrl}?start=${start}&end=${end}${status ? `&status=${status}` : ''}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const events = this.mapEvents(data);
                    successCallback(events);
                } catch (error) {
                    console.error('Error fetching events:', error);
                    failureCallback(error);
                }
            },

            mapEvents(events) {
                return events.map(event => {
                    const pendientes = event.pendiente_count || 0;
                    const aprobadas = event.aprobada_count || 0;
                    const rechazadas = event.rechazada_count || 0;
                    const total = pendientes + aprobadas + rechazadas;
                    
                    if (total === 0) return null;
                    
                    // Crear múltiples eventos si hay diferentes tipos de reservas
                    const eventosDelDia = [];
                    
                    if (aprobadas > 0) {
                        eventosDelDia.push({
                            title: `${aprobadas} Aprobada${aprobadas > 1 ? 's' : ''}`,
                            start: event.fecha_uso,
                            allDay: true,
                            backgroundColor: '#22c55e',
                            borderColor: '#22c55e',
                            textColor: 'white',
                            extendedProps: { 
                                estado: 'aprobada',
                                count: aprobadas
                            }
                        });
                    }
                    
                    if (pendientes > 0) {
                        eventosDelDia.push({
                            title: `${pendientes} Pendiente${pendientes > 1 ? 's' : ''}`,
                            start: event.fecha_uso,
                            allDay: true,
                            backgroundColor: '#f59e0b',
                            borderColor: '#f59e0b',
                            textColor: 'white',
                            extendedProps: { 
                                estado: 'pendiente',
                                count: pendientes
                            }
                        });
                    }
                    
                    if (rechazadas > 0) {
                        eventosDelDia.push({
                            title: `${rechazadas} Rechazada${rechazadas > 1 ? 's' : ''}`,
                            start: event.fecha_uso,
                            allDay: true,
                            backgroundColor: '#ef4444',
                            borderColor: '#ef4444',
                            textColor: 'white',
                            extendedProps: { 
                                estado: 'rechazada',
                                count: rechazadas
                            }
                        });
                    }
                    
                    return eventosDelDia;
                }).filter(event => event !== null).flat();
            },

            handleDateClick(info) {
                const fecha = info.dateStr;
                this.handleFechaSeleccionada(fecha);
            },

            handleEventClick(info) {
                info.jsEvent.preventDefault();
                const start = info.event.start;
                const dateStr = start.toISOString().slice(0, 10);
                this.handleFechaSeleccionada(dateStr);
            },

            handleFechaSeleccionada(fecha) {
                this.selectedDate = fecha.trim();
                this.highlightSelectedDate(fecha.trim());
                
                window.dispatchEvent(new CustomEvent('fecha-seleccionada', {
                    detail: fecha.trim()
                }));
            },

            highlightSelectedDate(fecha) {
                // Remover highlight anterior
                const previousSelected = document.querySelector('.fc-daygrid-day.selected-date');
                if (previousSelected) {
                    previousSelected.classList.remove('selected-date');
                }
                
                // Agregar highlight a la fecha seleccionada
                const selectedCell = document.querySelector(`[data-date="${fecha}"]`);
                if (selectedCell) {
                    selectedCell.classList.add('selected-date');
                }
            },

            loadReservasWithHTMX(fecha) {
                if (!fecha) return;
                
                // Disparar evento HTMX personalizado para cargar reservas
                const estado = this.filterStatus === 'all' ? '' : this.filterStatus;
                
                // Construir la URL con los parámetros necesarios
                let url = `/reservas/fecha/?fecha_uso=${fecha}`;
                if (estado) {
                    url += `&estado=${estado}`;
                }
                
                // Usar htmx.ajax para hacer la petición
                htmx.ajax('GET', url, {
                    target: '#reservas-list',
                    swap: 'innerHTML',
                    indicator: '#loading-reservas'
                });
            },

            // También actualizar setFilter para que funcione con la paginación
            setFilter(status) {
                this.filterStatus = status;
                if (this.calendar) {
                    this.calendar.refetchEvents();
                }
                // Si hay una fecha seleccionada, recargar las reservas con el nuevo filtro
                if (this.selectedDate) {
                    this.loadReservasWithHTMX(this.selectedDate);
                }
            },

            formatSelectedDate() {
                if (!this.selectedDate) return '';
                const date = new Date(this.selectedDate + 'T00:00:00');
                return date.toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
        }
    }
</script>
{% endblock scripts %}
