<!-- reservas/templates/includes/calendario_reservas.html -->
{% load static %}

<div x-data="reservasCalendar({
    reservasJsonUrl: '{% url 'reservas_json' %}',
    reservasByDateUrl: '{% url 'reservas_by_date_json' %}',
    editUrlTemplate: '{% url 'reserva_edit' 0 %}'.replace('0', 'RESERVATION_ID')
})" class="w-full">
    
    <!-- Calendario y Lista de Reservas -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
        
        <!-- Calendario - Ocupa 2/3 del ancho en pantallas grandes -->
        <div class="xl:col-span-2">
            <div class="bg-base-100 rounded-xl shadow-sm border border-base-200">
                <!-- Header del calendario con controles -->
                <div class="p-4 border-b border-base-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-900">Calendario de Reservas</h2>
                        <div class="flex gap-2">
                            <button 
                                @click="calendar.prev()"
                                class="btn btn-sm btn-outline"
                            >
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button 
                                @click="calendar.today()"
                                class="btn btn-sm btn-outline"
                            >
                                Hoy
                            </button>
                            <button 
                                @click="calendar.next()"
                                class="btn btn-sm btn-outline"
                            >
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Filtros de Estado -->
                <div class="p-4 border-b border-base-200 bg-base-200/50">
                    <div class="flex flex-wrap gap-2">
                        <span class="text-sm font-medium text-gray-700 mr-3">Mostrar:</span>
                        <button 
                            @click="setFilter('all')" 
                            class="btn btn-xs"
                            :class="filterStatus === 'all' ? 'btn-primary' : 'btn-ghost border'"
                            hx-trigger="click"
                            hx-get="/reservas/fecha/"
                            hx-target="#reservas-list"
                            hx-vals='{"estado": ""}'
                            hx-include="[name='fecha_uso']"
                        >
                            Todas
                        </button>
                        <button 
                            @click="setFilter('pendiente')" 
                            class="btn btn-xs"
                            :class="filterStatus === 'pendiente' ? 'btn-warning' : 'btn-ghost border'"
                            hx-trigger="click"
                            hx-get="/reservas/fecha/"
                            hx-target="#reservas-list"
                            hx-vals='{"estado": "pendiente"}'
                            hx-include="[name='fecha_uso']"
                        >
                            Pendientes
                        </button>
                        <button 
                            @click="setFilter('aprobada')" 
                            class="btn btn-xs"
                            :class="filterStatus === 'aprobada' ? 'btn-success' : 'btn-ghost border'"
                            hx-trigger="click"
                            hx-get="/reservas/fecha/"
                            hx-target="#reservas-list"
                            hx-vals='{"estado": "aprobada"}'
                            hx-include="[name='fecha_uso']"
                        >
                            Aprobadas
                        </button>
                        <button 
                            @click="setFilter('rechazada')" 
                            class="btn btn-xs"
                            :class="filterStatus === 'rechazada' ? 'btn-error' : 'btn-ghost border'"
                            hx-trigger="click"
                            hx-get="/reservas/fecha/"
                            hx-target="#reservas-list"
                            hx-vals='{"estado": "rechazada"}'
                            hx-include="[name='fecha_uso']"
                        >
                            Rechazadas
                        </button>
                    </div>
                </div>
                
                <!-- Calendario -->
                <div class="p-4">
                    <div id="calendar-{{ calendar_id|default:'main' }}"></div>
                </div>
            </div>
        </div>
        
        <!-- Panel de Reservas - Ocupa 1/3 del ancho en pantallas grandes -->
        <div class="xl:col-span-1">
            <div class="bg-base-100 rounded-xl shadow-sm border border-base-200 sticky top-4 flex flex-col" >
                <!-- Header del panel -->
                <div class=" p-4 border-b border-base-200">
                    <div class="mb-2">
                        <h3 class="text-lg font-semibold text-gray-900">
                            Reservas del día
                        </h3>
                        <div x-show="selectedDate" class="text-sm text-gray-500 mt-1" x-text="formatSelectedDate()"></div>
                        <!-- Campo oculto para almacenar la fecha seleccionada -->
                        <input type="hidden" name="fecha_uso" x-model="selectedDate" />
                        </div>
                    <div>
      
                </div>
                
                <!-- Contenido del panel con HTMX -->
                <div class="flex-1 flex flex-col min-h-0">
                    <div id="reservas-list" class="space-y-3 overflow-y-auto flex-1 pr-2">
                        <!-- Mensaje inicial -->
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-calendar-day text-3xl mb-3 text-gray-300"></i>
                            <p class="text-sm">Selecciona una fecha en el calendario</p>
                            <p class="text-xs text-gray-400 mt-1">para ver las reservas del día</p>
                        </div>
                    </div>
                </div>
                <div>
                    

                    
                </div>


            </div>
        </div>
    </div>
</div>

<style>
    /* Estilos básicos para FullCalendar */
    .fc .fc-toolbar-chunk .fc-button-primary {
        background-color: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }

    .fc .fc-daygrid-day.fc-day-today {
        background-color: rgba(59, 130, 246, 0.1);
    }

    .fc .fc-daygrid-day {
        cursor: pointer;
    }

    .fc .fc-daygrid-day.selected-date {
        background-color: rgba(59, 130, 246, 0.2) !important;
        border: 2px solid #3b82f6 !important;
    }

    .fc .fc-event {
        border: none;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
        padding: 2px 6px;
        margin: 1px 0;
        min-height: 18px;
        line-height: 1.3;
    }

    .fc .fc-event-title {
        font-weight: 500;
        font-size: 0.75rem;
    }

    /* Utilidad para truncar texto */
    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Loading indicator para HTMX */
    .htmx-indicator {
        display: none;
    }
    .htmx-request .htmx-indicator {
        display: inline;
    }
    .htmx-request.htmx-indicator {
        display: inline;
    }

    /* Responsive */
    @media (max-width: 1280px) {
        .fc .fc-toolbar {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .fc .fc-toolbar-chunk {
            display: flex;
            justify-content: center;
        }
    }
</style>

<script>
    function reservasCalendar(config = {}) {
        return {
            // Configuración
            reservasJsonUrl: config.reservasJsonUrl || '/api/reservas-json/',
            reservasByDateUrl: config.reservasByDateUrl || '/api/reservas-by-date-json/',
            editUrlTemplate: config.editUrlTemplate || '/reservas/edit/RESERVATION_ID/',
            calendarId: config.calendarId || 'main',

            // Estado
            filterStatus: 'all',
            selectedDate: null,
            calendar: null,

            // Inicialización
            init() {
                this.$nextTick(() => {
                    this.initCalendar();
                });

                // Escuchar eventos de fecha seleccionada
                window.addEventListener('fecha-seleccionada', (event) => {
                    this.selectedDate = event.detail;
                    this.loadReservasWithHTMX(this.selectedDate);
                });
            },

            // Métodos
            initCalendar() {
                const calendarEl = document.getElementById(`calendar-${this.calendarId}`);
                if (!calendarEl) {
                    console.error(`Calendar element with id 'calendar-${this.calendarId}' not found`);
                    return;
                }

                this.calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'es',
                    firstDay: 1,
                    validRange: {
                        start: new Date()
                    },
                    headerToolbar: {
                        left: '',
                        center: 'title',
                        right: ''
                    },
                    buttonText: {
                        today: 'Hoy',
                        month: 'Mes',
                        week: 'Semana',
                        day: 'Día'
                    },
                    events: this.fetchEvents.bind(this),
                    dateClick: this.handleDateClick.bind(this),
                    eventClick: this.handleEventClick.bind(this),
                    height: 'auto',
                    aspectRatio: 1.6
                });

                this.calendar.render();
                window.calendarInstance = this.calendar;
            },

            async fetchEvents(fetchInfo, successCallback, failureCallback) {
                try {
                    const start = fetchInfo.startStr;
                    const end = fetchInfo.endStr;
                    const status = this.filterStatus !== 'all' ? this.filterStatus : '';
                    
                    const url = `${this.reservasJsonUrl}?start=${start}&end=${end}${status ? `&status=${status}` : ''}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const events = this.mapEvents(data);
                    successCallback(events);
                } catch (error) {
                    console.error('Error fetching events:', error);
                    failureCallback(error);
                }
            },

            mapEvents(events) {
                return events.map(event => {
                    const pendientes = event.pendiente_count || 0;
                    const aprobadas = event.aprobada_count || 0;
                    const rechazadas = event.rechazada_count || 0;
                    const total = pendientes + aprobadas + rechazadas;
                    
                    if (total === 0) return null;
                    
                    // Crear múltiples eventos si hay diferentes tipos de reservas
                    const eventosDelDia = [];
                    
                    if (aprobadas > 0) {
                        eventosDelDia.push({
                            title: `${aprobadas} Aprobada${aprobadas > 1 ? 's' : ''}`,
                            start: event.fecha_uso,
                            allDay: true,
                            backgroundColor: '#22c55e',
                            borderColor: '#22c55e',
                            textColor: 'white',
                            extendedProps: { 
                                estado: 'aprobada',
                                count: aprobadas
                            }
                        });
                    }
                    
                    if (pendientes > 0) {
                        eventosDelDia.push({
                            title: `${pendientes} Pendiente${pendientes > 1 ? 's' : ''}`,
                            start: event.fecha_uso,
                            allDay: true,
                            backgroundColor: '#f59e0b',
                            borderColor: '#f59e0b',
                            textColor: 'white',
                            extendedProps: { 
                                estado: 'pendiente',
                                count: pendientes
                            }
                        });
                    }
                    
                    if (rechazadas > 0) {
                        eventosDelDia.push({
                            title: `${rechazadas} Rechazada${rechazadas > 1 ? 's' : ''}`,
                            start: event.fecha_uso,
                            allDay: true,
                            backgroundColor: '#ef4444',
                            borderColor: '#ef4444',
                            textColor: 'white',
                            extendedProps: { 
                                estado: 'rechazada',
                                count: rechazadas
                            }
                        });
                    }
                    
                    return eventosDelDia;
                }).filter(event => event !== null).flat();
            },

            handleDateClick(info) {
                const fecha = info.dateStr;
                this.handleFechaSeleccionada(fecha);
            },

            handleEventClick(info) {
                info.jsEvent.preventDefault();
                const start = info.event.start;
                const dateStr = start.toISOString().slice(0, 10);
                this.handleFechaSeleccionada(dateStr);
            },

            handleFechaSeleccionada(fecha) {
                this.selectedDate = fecha.trim();
                this.highlightSelectedDate(fecha.trim());
                
                window.dispatchEvent(new CustomEvent('fecha-seleccionada', {
                    detail: fecha.trim()
                }));
            },

            highlightSelectedDate(fecha) {
                // Remover highlight anterior
                const previousSelected = document.querySelector('.fc-daygrid-day.selected-date');
                if (previousSelected) {
                    previousSelected.classList.remove('selected-date');
                }
                
                // Agregar highlight a la fecha seleccionada
                const selectedCell = document.querySelector(`[data-date="${fecha}"]`);
                if (selectedCell) {
                    selectedCell.classList.add('selected-date');
                }
            },

            loadReservasWithHTMX(fecha) {
                if (!fecha) return;
                
                // Disparar evento HTMX personalizado para cargar reservas
                const estado = this.filterStatus === 'all' ? '' : this.filterStatus;
                
                // Construir la URL con los parámetros necesarios
                let url = `/reservas/fecha/?fecha_uso=${fecha}`;
                if (estado) {
                    url += `&estado=${estado}`;
                }
                
                // Usar htmx.ajax para hacer la petición
                htmx.ajax('GET', url, {
                    target: '#reservas-list',
                    swap: 'innerHTML',
                    indicator: '#loading-reservas'
                });
            },

            // También actualizar setFilter para que funcione con la paginación
            setFilter(status) {
                this.filterStatus = status;
                if (this.calendar) {
                    this.calendar.refetchEvents();
                }
                // Si hay una fecha seleccionada, recargar las reservas con el nuevo filtro
                if (this.selectedDate) {
                    this.loadReservasWithHTMX(this.selectedDate);
                }
            },

            formatSelectedDate() {
                if (!this.selectedDate) return '';
                const date = new Date(this.selectedDate + 'T00:00:00');
                return date.toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
        }
    }
</script>