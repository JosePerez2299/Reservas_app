{% load utils %}
{% if reservas %}
  <div class="w-full max-w-2xl mx-auto p-2">
    {% for reserva in reservas %}
      <div class="border-l-8 border-l-{{ reserva|get_color_reserva }} shadow-xl collapse collapse-arrow bg-base-100 border-b border-base-300 rounded-lg mb-2">
        <!-- Radio con mismo name para agrupar, checked en el primero -->
        <input 
          type="radio" 
          name="reservas-accordion" 
        />
        <!-- Título compacto -->
        <div class="collapse-title flex items-center justify-between">
          <div class="flex items-center space-x-3 flex-1 min-w-0">
            <!-- Avatar o inicial -->
            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
              <span class="text-xs font-medium text-blue-600">
                {{ reserva.usuario.first_name|first|default:reserva.usuario.username|first|upper }}
              </span>
            </div>
            <!-- Info principal -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center space-x-2">
                <h4 class="font-medium text-gray-900 text-sm truncate">
                  {{ reserva.usuario.get_full_name|default:reserva.usuario.username|truncatechars:15 }}
                </h4>
                <div class="badge p-1 badge-xs badge-{{ reserva|get_color_reserva }}">{{ reserva.estado|first|upper }}</div>
              </div>
              <p class="text-xs text-gray-500 truncate">{{ reserva.espacio.nombre|truncatechars:15 }}</p>
            </div>
          </div>
          <!-- Hora -->
          <div class="text-right">
            <div class="text-xs font-medium text-gray-900">
              {{ reserva.hora_inicio|time:"H:i a" }}
            </div>
            <div class="text-xs text-gray-500">
              {{ reserva.hora_fin|time:"H:i a" }}
            </div>
          </div>
        </div>
        <!-- Contenido expandido -->
        <div class="collapse-content">
          <div class="px-3 pt-2 pb-3 border-t border-base-300 bg-base-50">
            <!-- Detalles adicionales -->
            <div class="grid grid-cols-2 gap-3 mb-3 text-xs">
              <div>
                <span class="text-gray-500">Fecha:</span>
                <span class="ml-1 text-gray-900">{{ reserva.fecha_uso|date:"d/m/Y" }}</span>
              </div>
              <div>
                <span class="text-gray-500">Estado:</span>
                <span class="text-{{ reserva|get_color_reserva }}"> {{ reserva.estado|capfirst }}</span>
              </div>
              <div class="col-span-2 border-t border-base-300">
                <span class="text-gray-500">Espacio:</span>
                <span class="text-gray-900">{{ reserva.espacio.nombre }}</span>
                <div>
                  <span class="text-gray-500">Motivo:</span>
                  <span class="text-gray-900">{{ reserva.motivo|truncatechars:40 }}</span>
                </div>
              </div>
            </div>

            {% if perms.reservas.change_reserva %}
            <div class="flex gap-2">

              {% if reserva.estado == 'pendiente' %}
                <button
                onclick="generic_modal.showModal()"
                class="btn btn-primary btn-xs h-8 w-8 p-0 flex-1"
                hx-get="{% url 'reserva_edit' reserva.id %}"
                hx-target="#generic_modal_content"
                hx-swap="innerHTML"
              >
              <i class="fas fa-edit text-xs"></i>
              Editar
              </button>

              <button
              onclick="generic_modal.showModal()"
              class="btn btn-error btn-xs h-8 w-8 p-0 flex-1"
              hx-get="{% url 'reserva_delete' reserva.id %}"
              hx-target="#generic_modal_content"
              hx-swap="innerHTML"
            >
              <i class="fas fa-trash mr-1"></i>Eliminar
            </button>
            {% endif %}
              <button
              onclick="generic_modal.showModal()"
              class="btn btn-ghost btn-xs h-8 w-8 p-0 flex-1"
              hx-get="{% url 'reserva_view' reserva.id %}"
              hx-target="#generic_modal_content"
              hx-swap="innerHTML"
            >
            <i class="fas fa-eye text-xs"></i>
            Ver
           </button>


            
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}

    <!-- Paginación con HTMX -->
    {% if page_obj.has_other_pages %}
    <div class="flex justify-between items-center mt-4 pt-3 border-t border-gray-200 text-xs">
      <!-- Información de paginación (opcional ocultarla en pantallas pequeñas) -->
      <div class="text-gray-600 hidden sm:block">
        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
        ({{ page_obj.start_index }}-{{ page_obj.end_index }} de {{ page_obj.paginator.count }})
      </div>
      
      <!-- Controles de paginación compactos -->
      <div class="flex items-center space-x-1">
        <!-- Primera página -->
        {% if page_obj.has_previous and page_obj.number > 2 %}
          <button 
            hx-get="{% url 'reservas_by_date' %}?page=1{% if request.GET.fecha_uso %}&fecha_uso={{ request.GET.fecha_uso }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}"
            hx-target="#reservas-list"
            hx-indicator="#loading-reservas"
            class="btn btn-xs btn-ghost p-1"
            aria-label="Primera página" title="Primera">
            <i class="fas fa-angle-double-left"></i>
          </button>
        {% endif %}
  
        <!-- Anterior -->
        {% if page_obj.has_previous %}
          <button 
            hx-get="{% url 'reservas_by_date' %}?page={{ page_obj.previous_page_number }}{% if request.GET.fecha_uso %}&fecha_uso={{ request.GET.fecha_uso }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}"
            hx-target="#reservas-list"
            hx-indicator="#loading-reservas"
            class="btn btn-xs btn-ghost p-1"
            aria-label="Página anterior" title="Anterior">
            <i class="fas fa-angle-left"></i>
          </button>
        {% endif %}
  
        <!-- Indicador de página actual (solo icono o número) -->
        <span class="px-2">{{ page_obj.number }}</span>
  
        <!-- Siguiente -->
        {% if page_obj.has_next %}
          <button 
            hx-get="{% url 'reservas_by_date' %}?page={{ page_obj.next_page_number }}{% if request.GET.fecha_uso %}&fecha_uso={{ request.GET.fecha_uso }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}"
            hx-target="#reservas-list"
            hx-indicator="#loading-reservas"
            class="btn btn-xs btn-ghost p-1"
            aria-label="Página siguiente" title="Siguiente">
            <i class="fas fa-angle-right"></i>
          </button>
        {% endif %}
  
        <!-- Última página -->
        {% if page_obj.has_next and page_obj.number < page_obj.paginator.num_pages|add:'-1' %}
          <button 
            hx-get="{% url 'reservas_by_date' %}?page={{ page_obj.paginator.num_pages }}{% if request.GET.fecha_uso %}&fecha_uso={{ request.GET.fecha_uso }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}"
            hx-target="#reservas-list"
            hx-indicator="#loading-reservas"
            class="btn btn-xs btn-ghost p-1"
            aria-label="Última página" title="Última">
            <i class="fas fa-angle-double-right"></i>
          </button>
        {% endif %}
      </div>
    </div>
    
    <!-- Indicador de carga -->
    <div id="loading-reservas" class="htmx-indicator text-center py-2">
      <div class="loading loading-spinner loading-sm"></div>
      <span class="text-xs text-gray-500 ml-2">Cargando...</span>
    </div>
  {% endif %}
  
  </div>
{% else %}
  <div class="text-center py-8 text-gray-500">
    <i class="fas fa-calendar-times text-3xl mb-3 text-gray-300"></i>
    <p class="text-sm">No hay reservas para este día</p>
    <p class="text-xs text-gray-400 mt-1">con el filtro seleccionado</p>
  </div>
{% endif %}

