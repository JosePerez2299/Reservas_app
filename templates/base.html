{% load compress %} {% load static %}
{%load crispy_forms_tags %}


<!DOCTYPE html>
<html lang="en" x-data="themeSwitcher()" x-init="init()" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reservas CANTV</title>
    {% compress css %}
    <link rel="stylesheet" href="{% static 'src/css/output.css' %}" />
    {% endcompress %}
  </head>

  <body class="flex flex-col min-h-screen bg-base-100">
  <div class="flex flex-col min-h-screen">
    <div class="flex-grow">
    <div class="drawer flex flex-col min-h-screen">
      <input id="my-drawer-3" type="checkbox" class="drawer-toggle" />
      <div class="drawer-content flex flex-col flex-grow">
        <!-- Navbar -->
        <div class="navbar bg-base-200 w-full bg-gradient-to-r from-base-200 via-base-100 to-primary/20 text-base-content shadow-md">
          <div class="flex-none lg:hidden">
            <label for="my-drawer-3" aria-label="open sidebar" class="btn btn-square btn-ghost">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block h-6 w-6 stroke-current">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </label>
          </div>
          <div class="mx-2 flex-1 px-2">
            <div class="flex gap-2 items-center">
              <a href="{% url 'dashboard' %}" class="inline-block transition-transform duration-300 hover:scale-110">{% include 'includes/logo.html' %}</a>
              <div class="hidden lg:flex divider divider-horizontal"></div>

              {% if request.user.is_authenticated %}
              <p class="text-base-content text-sm hidden lg:block">Panel de <span class="font-bold">{{ group }}</span> / <span class="font-bold text-primary/85 ">{{ request.user.username }}</span></p>
              {% endif %}
            </div>
          </div>
          <div class="hidden flex-none lg:block">
            <ul class="menu menu-horizontal">
              {% if request.user.is_authenticated %}
                <li>
                  <a href="{% url 'dashboard' %}">Inicio</a>
                </li>

                {# Dropdowns por cada modelo con permisos #}
                {% for model, perms in dashboard_access.items %}
                  <li>
                    <a href="{% url model %}">{{ model|capfirst }}s</a>
                  </li>
                {% endfor %}

                {# Cerrar sesión #}
                <li>
                  <form method="post" action="{% url 'logout' %}">
                    {% csrf_token %}
                    <button type="submit">Cerrar sesión</button>
                </form>
                </li>
              {% else %}
                {# Si no está autenticado, sólo “Iniciar sesión” #}
                <li>
                  <a href="{% url 'login' %}">Iniciar sesión</a>
                </li>
              {% endif %}
                <li>
                  {% include 'includes/switch_theme.html' %}
                </li>
            </ul>
          </div>
        </div>
        <!-- Page content here -->
        <div class="h-[calc(100vh-4rem)]"> 
          {% block content %}

          {% endblock %}
          <dialog id="generic_modal" class="modal">
            <div class="modal-box">
              <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
              </form>
              <div id="generic_modal_content" style="padding:0"></div>
            </div>
            <form method="dialog" class="modal-backdrop">
              <button>close</button>
            </form>
          </dialog>

        </div>

      </div>



      <!-- Sidebar -->
      <div class="drawer-side">
        <label for="my-drawer-3" aria-label="close sidebar" class="drawer-overlay"></label>

        <ul class="menu bg-base-200 min-h-full w-80 p-4">
          <li class="menu-title text-base-content">
            <p>Panel de <span class="font-bold">{{ group }}</span> / <span class="font-bold">{{ request.user.username }}</span></p>
          </li>
          <div class="divider"></div>
          <!-- Sidebar content here -->
          {% if request.user.is_authenticated %}
            <li>
              <a href="{% url 'dashboard' %}">Inicio</a>
            </li>

            {# Dropdowns por cada modelo con permisos #}
            {% for model, perms in dashboard_access.items %}
              <li>
                <a href="{% url model %}">{{ model|capfirst }}s</a>
              </li>
            {% endfor %}

            {# Cerrar sesión #}
            <li>
              <a url="{% url 'logout' %}">Cerrar sesión</a>
            </li>
          {% else %}
            <li>
              <a href="{% url 'login' %}">Iniciar sesión</a>
            </li>
          {% endif %}
          <li>
            {% include 'includes/switch_theme.html' %}
          </li>
        </ul>
      </div>
      
    </div>
    <footer class="footer sm:footer-horizontal bg-gradient-to-b from-base-100 via-base-100 to-primary/40  text-base-content items-center p-4">
      <aside class="grid-flow-col items-center">
{% include 'includes/logo.html' %}
        <p>Copyright © 2025 - Todos los derechos reservados</p>
      </aside>
      <nav class="grid-flow-col gap-4 md:place-self-center md:justify-self-end">
        <a>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            class="fill-current">
            <path
              d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"></path>
          </svg>
        </a>
        <a>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            class="fill-current">
            <path
              d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"></path>
          </svg>
        </a>
        <a>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            class="fill-current">
            <path
              d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v3.385z"></path>
          </svg>
        </a>
      </nav>
    </footer>
  </div>
  <script>
    ;(function() {
      const modal   = document.getElementById('generic_modal');
      const content = document.getElementById('generic_modal_content');
    
      // Función que abre el modal para cualquier botón .open-modal-btn
      async function openModal(url, callbackName) {
        content.innerHTML = '';      // limpia contenido previo
        modal.showModal();
    
        try {
          const resp = await fetch(url, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });
          const html = await resp.text();
          content.innerHTML = html;
          bindForm(callbackName);
        } catch (err) {
          console.error(err);
          content.innerHTML = '<p class="p-4 text-red-600">Error cargando el formulario.</p>';
        }
      }
    
      // Función que enlaza el submit del formulario actualmente inyectado
      function bindForm(callbackName) {
        const form = content.querySelector('form');
        if (!form) return;
    
        // Guárdate la acción original y el callback en data-attrs, si no vienen en form.action
        const action = form.action;
        form.removeEventListener('submit', handleSubmit);
        form.addEventListener('submit', handleSubmit);
    
        async function handleSubmit(e) {
          e.preventDefault();
          const fd = new FormData(form);
    
          const resp = await fetch(action, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body:     fd
          });
    
          // Django responde JSON siempre
          const data = await resp.json();
    
          if (data.success) {
            modal.close();
            if (callbackName && typeof window[callbackName] === 'function') {
              window[callbackName](data);
            } else {
              // por defecto, recarga la página
              location.reload();
            }
          } else {
            // reinyecta el formulario con los errores
            content.innerHTML = data.html;
            // y vuelve a enlazar el handler sobre el nuevo <form>
            bindForm(callbackName);
          }
        }
      }
    
      // Delegación de clicks en botones que abran el modal
      document.addEventListener('click', function(e) {
        const btn = e.target.closest('.open-modal-btn');
        if (!btn) return;
    
        e.preventDefault();
        const url = btn.dataset.url;
        const callbackName = btn.dataset.successCallback;  // opcional
        openModal(url, callbackName);
      });
    })();
    </script>
    
  <script>
      function themeSwitcher() {
        return {
          // usamos booleano para simplificar el binding con el checkbox
          dark: localStorage.getItem('theme') === 'dark',
      
          init() {
            // al iniciar, aplicamos el tema según localStorage o preferencia del sistema
            this.applyTheme(this.dark)
          },
      
          toggle() {
            // invocado al hacer click sobre el swap
            this.dark = !this.dark
            this.applyTheme(this.dark)
          },
      
          applyTheme(isDark) {
            // ponemos el atributo data-theme que DaisyUI utiliza
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light')
            // guardamos la preferencia
            localStorage.setItem('theme', isDark ? 'dark' : 'light')
          }
        }
      }
    </script>

    <!-- Alpine Plugins -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/focus@3.x.x/dist/cdn.min.js"></script>

    <!-- Alpine Core -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  </body>
</html>
